name: ğŸ› ï¸ CrÃ©er un article depuis une Issue

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write

jobs:
  create-post:
    if: contains(github.event.issue.labels.*.name, 'article')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ‘‰ğŸ¼ Repo
        uses: actions/checkout@v4

      - name: Extraire les donnÃ©es de l'Issue
        id: extract
        run: |
          body="${{ github.event.issue.body }}"
          
          TITLE=$(echo "$body" | awk '/^### Titre de l'\''Article/{getline; print}' | xargs)
          DESCRIPTION=$(echo "$body" | awk '/^### Description/{getline; print}' | xargs)
          CONTENT=$(echo "$body" | awk '/^### Contenu complet/{flag=1; next} /^### Auteur/{flag=0} flag' | sed 's/\r//' )
          AUTHOR=$(echo "$body" | awk '/^### Auteur/{getline; print}' | xargs)
          TAGS=$(echo "$body" | awk '/^### Tags/{getline; print}' | xargs)

          echo "TITLE<<EOF" >> $GITHUB_ENV
          echo "$TITLE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "DESCRIPTION<<EOF" >> $GITHUB_ENV
          echo "$DESCRIPTION" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "CONTENT<<EOF" >> $GITHUB_ENV
          echo "$CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "TAGS=$TAGS" >> $GITHUB_ENV

      - name: GÃ©nÃ©rer le fichier article
        run: |
          SLUG=$(echo "$TITLE" | iconv -f utf8 -t ascii//TRANSLIT | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/-\+/-/g' | sed 's/^-//;s/-$//')
          DATE=$(date +"%Y-%m-%d")
          FILE="src/content/posts/$SLUG.md"

          mkdir -p src/content/posts

          echo "---" > "$FILE"
          echo "title: \"$TITLE\"" >> "$FILE"
          echo "description: \"$DESCRIPTION\"" >> "$FILE"
          echo "createdAt: $DATE" >> "$FILE"
          echo "author: \"$AUTHOR\"" >> "$FILE"
          echo "draft: true" >> "$FILE"
          echo "tags:" >> "$FILE"
          for tag in $(echo $TAGS | tr ',' '\n'); do
            echo "  - $(echo $tag | xargs)" >> "$FILE"
          done
          echo "---" >> "$FILE"
          echo "" >> "$FILE"
          echo "$CONTENT" >> "$FILE"

          echo "SLUG=$SLUG" >> $GITHUB_ENV

      - name: Commit + Push ğŸ’ª
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ“ Nouveau post: ${{ env.TITLE }}"
          branch: "article_${{ env.SLUG }}"
          create_branch: true

      - name: CrÃ©er une Pull Request ğŸ”€
        uses: peter-evans/create-pull-request@v5
        with:
          title: "ğŸ“ Proposition d'article: ${{ env.TITLE }}"
          body: |
            Cet article a Ã©tÃ© proposÃ© automatiquement depuis une Issue.

            Merci de le relire et de valider !
          labels: article
          base: master
          branch: "article_${{ env.SLUG }}"
